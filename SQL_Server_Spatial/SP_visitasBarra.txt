USE [BD_CARGA_JMAP]
GO
/****** Object:  StoredProcedure [dbo].[SP_visitasBarra]    Script Date: 23/02/2023 15:12:55 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 ALTER PROCEDURE [dbo].[SP_visitasBarra]
	@CCodCPNP varchar (4),
	@FechaIni varchar (30),
	@FechaFin varchar (30)

AS  
BEGIN 


SELECT SUM(TOTAL) TOTAL, SUM(CERO) CERO, SUM(UNO_TRES) TRES, SUM(CUATRO_CINCO) CINCO, SUM (CINCO_MAS) MASCINCO
FROM (
SELECT COD_CPNP,FECHA_REGISTRO_DENUNCIA,  COUNT(CAN_VISITA) AS TOTAL, 
        SUM(IIF(CAN_VISITA = 0 ,1,0)) CERO, 
		SUM(IIF(CAN_VISITA >= 1 AND CAN_VISITA <= 3  ,1 ,0 )) UNO_TRES ,
		SUM(IIF(CAN_VISITA > 3 AND CAN_VISITA <= 5  ,1 ,0 )) CUATRO_CINCO ,
		SUM(IIF(CAN_VISITA > 5 ,1 ,0 )) CINCO_MAS 
FROM (
SELECT COD_CPNP,FECHA_REGISTRO_DENUNCIA, (SELECT COUNT(*) CAN_VISITA
FROM  TG_VISITAS_PNP V 
WHERE X.ID_DENUNCIA_SIDPOL_L30364 = V.ID_DENUNCIA_SIDPOL) CAN_VISITA
FROM TM_DENUNCIAS_SIDPOL_L30364 X 
) Y
WHERE COD_CPNP IS NOT NULL
GROUP BY COD_CPNP,FECHA_REGISTRO_DENUNCIA
) Z
WHERE (@CCodCPNP IS NULL OR COD_CPNP = @CCodCPNP) 
AND   (@FechaIni IS NULL OR @FechaFin IS NULL or FECHA_REGISTRO_DENUNCIA between CONVERT(datetime, @FechaIni, 120) and CONVERT(datetime, @FechaFin, 120) ) 

END
